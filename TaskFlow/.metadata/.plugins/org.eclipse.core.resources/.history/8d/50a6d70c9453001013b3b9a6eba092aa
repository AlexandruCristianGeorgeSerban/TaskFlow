package com.taskflow.action;

import com.taskflow.model.Category;
import com.taskflow.model.Task;
import com.taskflow.ui.MainFrame;

import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;

@SuppressWarnings("serial")
public class AddTaskAction extends AbstractAction {
    private final MainFrame frame;

    /** Constructorul trebuie să primească exact MainFrame */
    public AddTaskAction(MainFrame frame) {
        super("Add Task");
        this.frame = frame;
    }

    @Override
    public void actionPerformed(ActionEvent e) {
        // 1) Obține categoria selectată
        Category cat = frame.getSelectedCategory();
        if (cat == null) {
            JOptionPane.showMessageDialog(frame,
                "Select a category first.",
                "Info", JOptionPane.INFORMATION_MESSAGE);
            return;
        }

        // 2) Titlu și descriere
        String title = JOptionPane.showInputDialog(frame, "Task title:");
        if (title == null || title.isBlank()) return;

        String desc = JOptionPane.showInputDialog(frame, "Task description:");
        if (desc == null) desc = "";

        // 3) Dată-limită (două formate acceptate)
        String dueStr = JOptionPane.showInputDialog(
            frame, "Due date (yyyy-MM-dd or yyyyMMdd):");
        Calendar dueDate;
        try {
            Date d;
            if (dueStr.contains("-")) {
                d = new SimpleDateFormat("yyyy-MM-dd").parse(dueStr);
            } else {
                d = new SimpleDateFormat("yyyyMMdd").parse(dueStr);
            }
            dueDate = Calendar.getInstance();
            dueDate.setTime(d);
        } catch (ParseException ex) {
            JOptionPane.showMessageDialog(frame,
                "Invalid date format.\nUse yyyy-MM-dd or yyyyMMdd",
                "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        // 4) Alege culoare cu ColorChooser
        Color chosen = JColorChooser.showDialog(
            frame, "Choose task color", Color.RED);
        String hex = (chosen == null)
            ? "#A00000"
            : String.format("#%02x%02x%02x",
                  chosen.getRed(), chosen.getGreen(), chosen.getBlue());

        // 5) Creează și adaugă task-ul
        Task t = new Task(
            title.trim(),
            desc.trim(),
            dueDate,
            false,
            hex
        );
        frame.getTaskService().addTask(cat, t);

        // 6) Reîmprospătează UI-ul pentru categoria curentă
        frame.refreshAfterChange(cat);
    }
}
