package com.taskflow.persistence;

import com.taskflow.model.Category;
import com.taskflow.model.Task;
import org.w3c.dom.*;
import javax.xml.parsers.*;
import javax.xml.transform.*;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import java.io.File;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;

/**
 * Handler pentru export/import folosind DOM.
 */
public class XmlDomHandler implements CategoryPersistence {

    @Override
    public List<Category> load(File file) throws Exception {
        List<Category> categories = new ArrayList<>();
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        DocumentBuilder builder = factory.newDocumentBuilder();
        Document doc = builder.parse(file);
        Element root = doc.getDocumentElement();

        NodeList catNodes = root.getElementsByTagName("category");
        for (int i = 0; i < catNodes.getLength(); i++) {
            Element catElem = (Element) catNodes.item(i);
            Category cat = new Category();
            // setId(String) va face UUID.fromString intern
            cat.setId(UUID.fromString(catElem.getAttribute("id")));
            cat.setName(catElem.getAttribute("name"));
            cat.setColor(catElem.getAttribute("color"));

            NodeList taskNodes = catElem.getElementsByTagName("task");
            for (int j = 0; j < taskNodes.getLength(); j++) {
                Element taskElem = (Element) taskNodes.item(j);
                Task t = new Task();
                t.setId(taskElem.getAttribute("id"));
                t.setTitle(taskElem.getAttribute("title"));
                t.setCompleted(Boolean.parseBoolean(taskElem.getAttribute("completed")));

                Element descElem = (Element) taskElem.getElementsByTagName("description").item(0);
                t.setDescription(descElem.getTextContent());

                Element dueElem = (Element) taskElem.getElementsByTagName("dueDate").item(0);
                String[] parts = dueElem.getTextContent().split("-");
                Calendar cal = Calendar.getInstance();
                cal.set(
                    Integer.parseInt(parts[0]),
                    Integer.parseInt(parts[1]) - 1,
                    Integer.parseInt(parts[2])
                );
                t.setDueDate(cal);

                cat.addTask(t);
            }
            categories.add(cat);
        }
        return categories;
    }

    @Override
    public void save(List<Category> categories, File file) throws Exception {
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        DocumentBuilder builder = factory.newDocumentBuilder();
        Document doc = builder.newDocument();

        Element root = doc.createElement("categories");
        doc.appendChild(root);

        for (Category cat : categories) {
            Element catElem = doc.createElement("category");
            catElem.setAttribute("id", cat.getId());
            catElem.setAttribute("name", cat.getName());
            catElem.setAttribute("color", cat.getColor());

            for (Task t : cat.getTasks()) {
                Element taskElem = doc.createElement("task");
                taskElem.setAttribute("id", t.getId());
                taskElem.setAttribute("title", t.getTitle());
                taskElem.setAttribute("completed", Boolean.toString(t.isCompleted()));

                Element desc = doc.createElement("description");
                desc.setTextContent(t.getDescription());
                taskElem.appendChild(desc);

                Element due = doc.createElement("dueDate");
                Calendar cal = t.getDueDate();
                String dateStr = String.format("%d-%02d-%02d",
                        cal.get(Calendar.YEAR),
                        cal.get(Calendar.MONTH) + 1,
                        cal.get(Calendar.DAY_OF_MONTH));
                due.setTextContent(dateStr);
                taskElem.appendChild(due);

                catElem.appendChild(taskElem);
            }
            root.appendChild(catElem);
        }

        Transformer transformer = TransformerFactory.newInstance().newTransformer();
        transformer.transform(new DOMSource(doc), new StreamResult(file));
    }
}
